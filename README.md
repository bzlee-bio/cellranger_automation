# Cell Ranger Automation Script

Automate the processing of single-cell RNA sequencing (scRNA-seq) data using 10x Genomics' Cell Ranger. This script manages multiple samples, handles parallel processing, and generates a summary report in TSV format for easy downstream analysis.

## Table of Contents

- [Prerequisites](#prerequisites)
- [Folder Structure](#folder-structure)
- [Configuration](#configuration)
- [Running the Script](#running-the-script)
- [Outputs](#outputs)
- [Example Workflow](#example-workflow)
- [Common Issues and Tips](#common-issues-and-tips)
- [License](#license)

---

## Prerequisites

Before you begin, ensure you have the following:

1. **Operating System**: Unix-based system (Linux, macOS).
2. **Cell Ranger**: Installed and accessible.
3. **NFS Mounted Directories**: Ensure execution permissions are set correctly.
4. **Bash Shell**: Compatible version (Bash 4.0+ recommended).
5. **Sufficient Resources**: CPU cores and memory for parallel processing.

## Folder Structure

Organize your data and directories as follows:

```bash
/path/to/target_folder/          # Main target folder (argument to the script)
└── Raw/
    └── fastq/
        ├── sampleA/             # Each sample folder contains FASTQ files
        │   ├── sampleA_S1_L001_R1_001.fastq.gz
        │   ├── sampleA_S1_L001_R2_001.fastq.gz
        │   └── ...               # Additional FASTQ files as needed
        ├── sampleB/
        │   ├── sampleB_S1_L001_R1_001.fastq.gz
        │   ├── sampleB_S1_L001_R2_001.fastq.gz
        │   └── ...
        ├── sampleC/
        │   ├── sampleC_S1_L001_R1_001.fastq.gz
        │   ├── sampleC_S1_L001_R2_001.fastq.gz
        │   └── ...
        └── ...                 # Additional samples as needed
```

### Description

- **`/path/to/target_folder/`**:  
  The main directory you will specify when running the script. This folder will contain both your raw data and the outputs generated by Cell Ranger.

- **`Raw/fastq/`**:  
  Contains subdirectories for each sample. Each sample folder holds the corresponding FASTQ files required for Cell Ranger processing.

- **`sampleA/`, `sampleB/`, `sampleC/`, ...**:  
  Individual sample directories. Each should contain paired-end FASTQ files following a consistent naming convention. The naming typically includes:
  - **Sample Name** (e.g., `sampleA`)
  - **Sample Number** (e.g., `S1`)
  - **Lane Number** (e.g., `L001`)
  - **Read Number** (`R1` for Read 1 and `R2` for Read 2)
  - **Index Number** (e.g., `001`)
  
  **Example File Names:**
  - `sampleA_S1_L001_R1_001.fastq.gz`
  - `sampleA_S1_L001_R2_001.fastq.gz`

### Best Practices

1. **Consistent Naming Convention**:  
   Ensure all FASTQ files follow a consistent naming pattern. This consistency helps Cell Ranger accurately identify and process the paired-end reads for each sample.

2. **Organize Samples Clearly**:  
   Each sample should have its own dedicated folder within `Raw/fastq/`. Avoid mixing files from different samples in a single directory to prevent processing errors.

3. **Compress FASTQ Files**:  
   FASTQ files should be compressed using `gzip` (i.e., `.fastq.gz`). This reduces storage space and can speed up file transfers.

4. **Verify File Integrity**:  
   Before running the script, ensure that all FASTQ files are complete and not corrupted. You can use tools like `fastqc` for quality checks.

5. **Backup Raw Data**:  
   Always maintain backups of your raw FASTQ files to prevent data loss during processing.

### Example Folder Structure

Here’s an example of how your folder structure might look:

```bash
/data/MyProject/
├── Raw/
│   └── fastq/
│       ├── Sample1/
│       │   ├── Sample1_S1_L001_R1_001.fastq.gz
│       │   ├── Sample1_S1_L001_R2_001.fastq.gz
│       │   └── Sample1_S1_L002_R1_001.fastq.gz
│       ├── Sample2/
│       │   ├── Sample2_S1_L001_R1_001.fastq.gz
│       │   ├── Sample2_S1_L001_R2_001.fastq.gz
│       │   └── Sample2_S1_L002_R1_001.fastq.gz
│       └── Sample3/
│           ├── Sample3_S1_L001_R1_001.fastq.gz
│           ├── Sample3_S1_L001_R2_001.fastq.gz
│           └── Sample3_S1_L002_R1_001.fastq.gz
└── cellranger/
    ├── Sample1/
    │   ├── cellranger_Sample1.log
    │   └── outs/
    ├── Sample2/
    │   ├── cellranger_Sample2.log
    │   └── outs/
    ├── Sample3/
    │   ├── cellranger_Sample3.log
    │   └── outs/
    └── cellranger_completion_report.tsv
```

### Additional Notes

- **Multiple Lanes**:  
  If your sequencing run involves multiple lanes (e.g., `L001`, `L002`), include all relevant FASTQ files within the sample’s directory. Cell Ranger will automatically handle multiple lanes during processing.

- **Sample Multiplexing**:  
  If you have samples multiplexed with different barcodes, ensure each sample's FASTQ files are correctly labeled and placed in their respective directories to avoid cross-sample contamination.

- **Storage Considerations**:  
  Given the potentially large size of FASTQ files, ensure that the target folder is located on a storage system with sufficient capacity and performance to handle read/write operations efficiently.

---

## Configuration

Create a configuration file named `config.txt` in the **same directory** as the script. This file specifies the paths to the Cell Ranger executable and the reference transcriptome.

### `config.txt` Example:

```bash
cellranger_path=/full/path/to/cellranger
reference_path=/full/path/to/reference
```

**Parameters:**

- **`cellranger_path`**: Full path to your `cellranger` executable.  
  *Example*: `/mnt/gluster_server/Tools/cellranger-9.0.0/bin/cellranger`

- **`reference_path`**: Full path to your 10x reference transcriptome directory.  
  *Example*: `/mnt/gluster_server/refdata-gex-GRCh38-2020-A`

**Ensure:**

- Both paths are absolute and correct.
- The `cellranger` executable has execute permissions (`chmod +x`).

---

## Running the Script

### 1. **Make the Script Executable**

Navigate to the directory containing the script and run:

```bash
chmod +x cellranger_automation.sh
```

### 2. **Execute the Script with Required Arguments**

The script requires two arguments:

1. **Target Folder**: The main data directory (e.g., `/path/to/target_folder`).
2. **Max Concurrent Jobs**: Number of parallel Cell Ranger jobs to run (e.g., `3`).

**Command Syntax:**

```bash
./cellranger_automation.sh <target_folder> <max_concurrent_jobs>
```

**Example:**

```bash
./cellranger_automation.sh /data/MyProject 3
```

**What This Does:**

- Scans `/data/MyProject/Raw/fastq/` for sample directories.
- Processes each sample with `cellranger count`, up to 4 parallel jobs.
- Outputs results to `/data/MyProject/cellranger/<sample_name>/`.

### 3. **Monitor Progress**

- **Console Output**: Displays logs indicating which samples are being processed or skipped.
- **Log Files**: Each sample has a dedicated log file at `/data/MyProject/cellranger/<sample_name>/cellranger_<sample_name>.log`.

### 4. **Skip Processed Samples**

- **Already Processed**: If a sample’s `outs` directory exists, it is skipped.
- **Incomplete Runs**: If a sample’s output directory exists but lacks `outs`, it is removed and reprocessed.

---

## Outputs

### 1. **Cell Ranger Outputs**

For each sample (`sampleA`, `sampleB`, etc.), the script generates:

```
/path/to/target_folder/cellranger/sampleA/
├── cellranger_sampleA.log  # Log of the Cell Ranger run
└── outs/                   # Generated by Cell Ranger upon successful completion
```

- **`outs/`**: Contains standard Cell Ranger outputs such as `web_summary.html`, `possorted_bam.bam`, `filtered_feature_bc_matrix`, etc.

### 2. **TSV Completion Report**

After all jobs finish, a summary report is created in TSV format:

```
/path/to/target_folder/cellranger/cellranger_completion_report.tsv
```

**Sample Content:**

```
Sample	Output_Folder_Exists	Outs_Subfolder_Exists
sampleA	Yes	Yes
sampleB	Yes	Yes
sampleC	Yes	No
...
```

**Columns:**

- **Sample**: Name of the sample.
- **Output_Folder_Exists**: Indicates if the output folder was created (`Yes` or `No`).
- **Outs_Subfolder_Exists**: Indicates if the `outs` subfolder exists, signaling a successful run (`Yes` or `No`).

### 3. **Log Files**

Each sample has a log file for detailed information and troubleshooting:

```
/path/to/target_folder/cellranger/<sample_name>/cellranger_<sample_name>.log
```

**Usage:**

- Check these logs if any errors occur during the `cellranger count` run.

---

## Example Workflow

### 1. **Prepare Folder Structure**

```
/data/MyProject/
└── Raw/
    └── fastq/
        ├── Sample1/
        │   ├── Sample1_S1_L001_R1_001.fastq.gz
        │   └── Sample1_S1_L001_R2_001.fastq.gz
        └── Sample2/
            ├── Sample2_S1_L001_R1_001.fastq.gz
            └── Sample2_S1_L001_R2_001.fastq.gz
```

### 2. **Configure `config.txt`**

```bash
cellranger_path=/opt/cellranger-7.1.0/bin/cellranger
reference_path=/opt/refdata-gex-GRCh38-2020-A
```

### 3. **Run the Script**

```bash
./cellranger_automation.sh /data/MyProject 4
```

### 4. **Check Outputs**

- **Sample1**:  
  `outs` folder and log file at `/data/MyProject/cellranger/Sample1/`.

- **Sample2**:  
  `outs` folder and log file at `/data/MyProject/cellranger/Sample2/`.

- **Summary Report**:  
  `/data/MyProject/cellranger/cellranger_completion_report.tsv`.

---

## Common Issues and Tips

### 1. **Permission Denied**

- **Cause**: Lack of execute permissions on the `cellranger` executable or restrictive NFS mount options.
- **Solution**:
  - Ensure `cellranger` is executable:
    ```bash
    chmod +x /path/to/cellranger
    ```
  - Verify NFS mount options include `exec`. If not, remount with `exec`:
    ```bash
    sudo mount -o remount,exec /mnt/gluster_server
    ```
  - Check ownership and permissions of all relevant directories.

### 2. **Missing FASTQ Files**

- **Cause**: FASTQ files not present in the expected sample directories.
- **Solution**:  
  - Verify FASTQ files are correctly placed in `/path/to/target_folder/Raw/fastq/<sample>/`.

### 3. **Incorrect Paths in `config.txt`**

- **Cause**: Typographical errors or incorrect absolute paths.
- **Solution**:  
  - Double-check the paths specified in `config.txt`.
  - Ensure both `cellranger_path` and `reference_path` are correct and accessible.

### 4. **Concurrent Jobs Overloading System**

- **Cause**: Setting `max_concurrent_jobs` too high, leading to resource exhaustion.
- **Solution**:  
  - Choose a `max_concurrent_jobs` value that matches your system’s CPU and memory capacity.
  - Monitor system performance and adjust as necessary.

### 5. **Incomplete or Corrupted Output Directories**

- **Cause**: Previous runs were interrupted or failed, leaving partial data.
- **Solution**:  
  - Manually remove problematic output directories:
    ```bash
    rm -rf /path/to/target_folder/cellranger/<sample>
    ```
  - Ensure the script has the necessary permissions to delete and create directories.

### 6. **Handling 10x Cloud Token Warnings**

- **Cause**: Cell Ranger cannot find a 10x cloud token for cell annotation.
- **Solution**:
  - **Ignore** if cloud annotation is not needed.
  - **Set Up Token** if you require cloud-based annotation features:
    ```bash
    cellranger cloud auth setup
    ```
  - Alternatively, supply a token path using `--tenx-cloud-token-path` in the script.

---

## License

This project is licensed under the [MIT License](LICENSE).

---

**Note:** Always ensure that your data and scripts are backed up before running batch processing tasks to prevent accidental data loss.



